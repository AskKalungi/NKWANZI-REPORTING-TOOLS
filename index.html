<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NATIVE AGROFOODS UG - Maize Milling Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm & Assuring -->
    <!-- Application Structure Plan: The SPA is structured with a tab-based navigation to separate core user tasks: Dashboard Overview, Daily Data Entry, Detailed Reports, and Download Reports. A robust login and sign-up system using Firebase Authentication is implemented, gating access to the main content. All operational data is now persistently stored and retrieved from Firebase Firestore, ensuring data integrity and multi-staff access. -->
    <!-- Visualization & Content Choices: Report Info -> Goal -> Viz/Presentation Method -> Interaction -> Justification -> Library/Method. 1. Key Metrics (Today's Profit, MTD Sales) -> Inform -> Large Number KPIs -> Instant read -> Provides immediate business health status. 2. Monthly Profit -> Change -> Bar Chart -> Hover for details -> Compares discrete time periods effectively (Chart.js/Canvas). 3. Production & Revenue Mix -> Compare -> Donut Charts -> Hover for percentages -> Ideal for showing part-to-whole composition (Chart.js/Canvas). 4. Daily Operations -> Organize -> HTML Form & Table -> Form submission and display uses Firebase Firestore -> Standard, intuitive method for data entry and real-time review. 5. Downloadable Reports -> Inform/Organize -> Form with Download Button (data from Firestore) -> User selection of report type and period leads to CSV download -> Provides data portability and offline analysis. 6. Login/Signup Page -> Secure Access -> Forms with input fields and buttons -> Firebase Auth handles email/password login, account creation, and email verification. A 'show password' toggle is added for improved usability. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F0F4F8; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-h-96px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .nav-link { cursor: pointer; padding: 0.75rem 1.5rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .nav-link.active { border-color: #4A90E2; color: #4A90E2; font-weight: 600; }
        .kpi-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; text-align: center; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        #auth-section { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #E0E7ED; padding: 1rem; }
        #auth-form-card { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 100%; max-width: 400px; }
        .hidden { display: none; }
        .password-input-container { position: relative; }
        .toggle-password-visibility {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6B7280;
            font-size: 1.125rem; /* 18px */
            padding: 0.25rem;
        }
    </style>
</head>
<body>

    <div id="auth-section">
        <div id="auth-form-card">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">NATIVE AGROFOODS UG</h2>
            <p id="auth-title" class="text-center text-gray-600 mb-6">Staff Login</p>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="password-input-container">
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 pr-10 focus:ring-blue-500 focus:border-blue-500">
                    <button type="button" id="toggle-password-visibility" class="toggle-password-visibility">üëÅÔ∏è</button>
                </div>
                <div id="auth-error-message" class="text-red-600 text-sm text-center hidden"></div>
                <div id="email-verification-message" class="text-green-600 text-sm text-center hidden">Verification email sent! Please check your inbox.</div>
                <button type="submit" id="auth-submit-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">Login</button>
            </form>
            <div class="mt-4 text-center">
                <button id="toggle-auth-mode" class="text-blue-600 hover:underline text-sm">Don't have an account? Sign Up</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">NATIVE AGROFOODS UG</h1>
                    <p class="text-gray-500">Maize Milling Dashboard</p>
                    <p id="user-id-display" class="text-sm text-gray-400 mt-1">User ID: Loading...</p>
                </div>
                <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition">Logout</button>
            </div>
            <nav class="border-b border-gray-200">
                <div class="container mx-auto px-4 flex">
                    <a id="nav-dashboard" class="nav-link active">Dashboard</a>
                    <a id="nav-entry" class="nav-link">Data Entry</a>
                    <a id="nav-reports" class="nav-link">Reports</a>
                    <a id="nav-download" class="nav-link">Download Reports</a>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-4 md:p-8">
            
            <section id="view-dashboard" class="content-section active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">Today's Profit</h3>
                        <p id="kpi-today-profit" class="text-3xl font-bold text-green-600 mt-2">0 UGX</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">This Month's Sales</h3>
                        <p id="kpi-month-sales" class="text-3xl font-bold text-blue-600 mt-2">0 UGX</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">This Month's Profit</h3>
                        <p id="kpi-month-profit" class="text-3xl font-bold text-green-600 mt-2">0 UGX</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">Maize Milled (Tonnes)</h3>
                        <p id="kpi-month-milled-tonnes" class="text-3xl font-bold text-gray-800 mt-2">0 Tonnes</p>
                </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-700">Monthly Profit (Current Year)</h2>
                        <div class="chart-container mt-4">
                            <canvas id="monthlyProfitChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-700">Revenue Sources (YTD)</h2>
                        <div class="chart-container mt-4">
                            <canvas id="revenueSourceChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-entry" class="content-section">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Log Daily Operations</h2>
                        <form id="daily-entry-form" class="space-y-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="date" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="maize-purchased" class="block text-sm font-medium text-gray-700">Fresh Maize Purchased (Kg)</label>
                                <input type="number" step="0.01" id="maize-purchased" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="maize-unit-price" class="block text-sm font-medium text-gray-700">Unit Price of Fresh Maize (UGX/Kg)</label>
                                <input type="number" step="0.01" id="maize-unit-price" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="flour-produced" class="block text-sm font-medium text-gray-700">Actual Maize Flour Produced (Kg)</label>
                                <input type="number" step="0.01" id="flour-produced" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="flour-sold" class="block text-sm font-medium text-gray-700">Sales of Maize Flour (Kg)</label>
                                <input type="number" step="0.01" id="flour-sold" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="flour-price" class="block text-sm font-medium text-gray-700">Unit Price of Maize Flour (UGX/Kg)</label>
                                <input type="number" id="flour-price" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="bran-sold" class="block text-sm font-medium text-gray-700">Sales of Maize Bran (Kg)</label>
                                <input type="number" step="0.01" id="bran-sold" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="bran-price" class="block text-sm font-medium text-gray-700">Unit Price of Maize Bran (UGX/Kg)</label>
                                <input type="number" id="bran-price" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">Add Log Entry</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Recent Entries</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Date</th>
                                        <th scope="col" class="px-6 py-3">Maize In (Kg)</th>
                                        <th scope="col" class="px-6 py-3">Revenue (UGX)</th>
                                        <th scope="col" class="px-6 py-3">Profit (UGX)</th>
                                    </tr>
                                </thead>
                                <tbody id="log-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-reports" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Generate Report</h2>
                    <div class="flex flex-wrap gap-4 items-center mb-6 border-b pb-6">
                        <div>
                            <label for="report-year" class="block text-sm font-medium text-gray-700">Year</label>
                            <select id="report-year" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="report-month" class="block text-sm font-medium text-gray-700">Month</label>
                            <select id="report-month" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="all">All Year</option>
                            </select>
                        </div>
                    </div>
                    <div id="report-output">
                        <p class="text-gray-500 text-center">Select a year and month to generate a report.</p>
                    </div>
                </div>
            </section>

            <section id="view-download" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Download Reports</h2>
                    <div class="flex flex-col md:flex-row gap-4 items-start mb-6 border-b pb-6">
                        <div class="flex-grow w-full md:w-auto">
                            <label for="download-report-type" class="block text-sm font-medium text-gray-700">Report Type</label>
                            <select id="download-report-type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="daily_log">Daily Operations Log (CSV)</option>
                                <!-- Future report types could be added here -->
                                <!-- <option value="monthly_summary">Monthly Summary (CSV)</option> -->
                                <!-- <option value="annual_summary">Annual Summary (CSV)</option> -->
                            </select>
                        </div>
                        <div class="w-full md:w-auto">
                            <label for="download-year" class="block text-sm font-medium text-gray-700">Year (for Daily Log)</label>
                            <select id="download-year" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></select>
                        </div>
                        <div class="w-full md:w-auto">
                            <label for="download-month" class="block text-sm font-medium text-gray-700">Month (for Daily Log)</label>
                            <select id="download-month" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="all">All Months</option>
                            </select>
                        </div>
                        <button id="download-button" class="mt-6 md:mt-1 block w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition self-end">Generate & Download</button>
                    </div>
                    <div id="download-status" class="text-center text-gray-600 mt-4"></div>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        // Corrected import: added signInWithCustomToken
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // Firebase config and app ID will be injected by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Initialize Firebase on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const state = {
                activeView: 'dashboard',
                charts: {},
                dbData: [], // This will now hold data fetched from Firestore
                isLoggedIn: false, // Initial state, determined by Firebase Auth
                currentUser: null,
                authReady: false // To track if Firebase auth state is initialized
            };

            const processData = (entry) => {
                const maizeMilled = entry.maizePurchased;
                const costMaize = entry.maizePurchased * entry.maizeUnitPrice;
                const branProduced = maizeMilled * 0.3;
                const flourRevenue = entry.flourSold * entry.flourPrice;
                const branRevenue = entry.branSold * entry.branPrice;
                const totalRevenue = flourRevenue + branRevenue;
                const profit = totalRevenue - costMaize;
                return { ...entry, costMaize, maizeMilled, branProduced, flourRevenue, branRevenue, totalRevenue, profit };
            };

            const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'UGX', minimumFractionDigits: 0 }).format(value);

            function updateUI() {
                const authSection = document.getElementById('auth-section');
                const mainContent = document.getElementById('main-content');
                const views = document.querySelectorAll('.content-section');
                const navLinks = document.querySelectorAll('.nav-link');
                const userIdDisplay = document.getElementById('user-id-display');

                if (state.isLoggedIn && state.authReady) {
                    if (authSection) authSection.classList.add('hidden');
                    if (mainContent) mainContent.classList.remove('hidden');

                    views.forEach(view => view.classList.remove('active'));
                    navLinks.forEach(link => link.classList.remove('active'));

                    document.getElementById(`view-${state.activeView}`).classList.add('active');
                    document.getElementById(`nav-${state.activeView}`).classList.add('active');

                    if (userIdDisplay && state.currentUser) {
                        userIdDisplay.textContent = `User ID: ${state.currentUser.uid}`;
                    }

                    if (state.activeView === 'dashboard') renderDashboard();
                    if (state.activeView === 'entry') renderEntryLog();
                    if (state.activeView === 'reports') renderReportsView();
                    if (state.activeView === 'download') renderDownloadReportsView();

                } else if (state.authReady) { // Auth is ready, but not logged in
                    if (authSection) authSection.classList.remove('hidden');
                    if (mainContent) mainContent.classList.add('hidden');
                }
            }

            // --- Firebase Auth State Listener ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.isLoggedIn = true;
                    state.currentUser = user;
                    localStorage.setItem('isLoggedIn', 'true'); // Persist login state
                    
                    // Set up Firestore listener for this user's data
                    const userDailyLogsCollectionRef = collection(db, `artifacts/${appId}/users/${user.uid}/dailyLogs`);
                    onSnapshot(userDailyLogsCollectionRef, (snapshot) => {
                        state.dbData = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            // Ensure data has all required fields for processing, or set defaults
                            state.dbData.push(processData({
                                date: data.date,
                                maizePurchased: data.maizePurchased || 0,
                                maizeUnitPrice: data.maizeUnitPrice || 0,
                                flourProduced: data.flourProduced || 0,
                                flourSold: data.flourSold || 0,
                                flourPrice: data.flourPrice || 0,
                                branSold: data.branSold || 0,
                                branPrice: data.branPrice || 0,
                                id: doc.id // Store document ID for potential future use (e.g., editing/deleting)
                            }));
                        });
                        state.dbData.sort((a,b) => new Date(b.date) - new Date(a.date)); // Sort in memory
                        updateUI(); // Re-render UI with new data
                    }, (error) => {
                        console.error("Error fetching Firestore data:", error);
                    });

                } else {
                    state.isLoggedIn = false;
                    state.currentUser = null;
                    localStorage.removeItem('isLoggedIn');
                    state.dbData = []; // Clear data if logged out
                }
                state.authReady = true; // Firebase Auth state has been determined
                updateUI();
            });

            // Initial anonymous sign-in or custom token sign-in
            async function initializeAuth() {
                try {
                    // Prioritize anonymous sign-in for general functionality in Canvas
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Firebase auth initialization error:", error);
                    // If anonymous sign-in fails for some reason (e.g., misconfiguration),
                    // try custom token if available, though it's the source of the invalid-claims error
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (customTokenError) {
                            console.error("Firebase custom token sign-in error:", customTokenError);
                        }
                    }
                }
            }
            initializeAuth();


            function renderDashboard() {
                const today = new Date('2025-06-26T00:00:00'); // Example fixed date for demo purposes
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();

                const todayData = state.dbData.find(d => new Date(d.date).toDateString() === today.toDateString());
                
                const kpiTodayProfit = document.getElementById('kpi-today-profit');
                if (kpiTodayProfit) {
                    kpiTodayProfit.textContent = todayData ? formatCurrency(todayData.profit) : formatCurrency(0);
                }

                const monthData = state.dbData.filter(d => new Date(d.date).getMonth() === currentMonth && new Date(d.date).getFullYear() === currentYear);
                const monthSales = monthData.reduce((sum, d) => sum + d.totalRevenue, 0);
                const monthProfit = monthData.reduce((sum, d) => sum + d.profit, 0);
                const monthMaizeMilledKg = monthData.reduce((sum, d) => sum + d.maizeMilled, 0);
                const monthMaizeMilledTonnes = (monthMaizeMilledKg / 1000).toFixed(2); 

                const kpiMonthSales = document.getElementById('kpi-month-sales');
                if (kpiMonthSales) {
                    kpiMonthSales.textContent = formatCurrency(monthSales);
                }
                const kpiMonthProfit = document.getElementById('kpi-month-profit');
                if (kpiMonthProfit) {
                    kpiMonthProfit.textContent = formatCurrency(monthProfit);
                }
                const kpiMonthMilledTonnes = document.getElementById('kpi-month-milled-tonnes');
                if (kpiMonthMilledTonnes) {
                    kpiMonthMilledTonnes.textContent = `${monthMaizeMilledTonnes} Tonnes`;
                }
                
                const yearData = state.dbData.filter(d => new Date(d.date).getFullYear() === currentYear);
                const yearProfit = yearData.reduce((sum, d) => sum + d.profit, 0);
                const kpiYearProfit = document.getElementById('kpi-year-profit');
                if (kpiYearProfit) {
                    kpiYearProfit.textContent = formatCurrency(yearProfit);
                }
                
                renderMonthlyProfitChart(currentYear);
                renderRevenueSourceChart(yearData);
            }
            
            const chartDefaultOptions = {
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: (value) => new Intl.NumberFormat('en-US', { notation: "compact", compactDisplay: "short" }).format(value) } },
                    x: { grid: { display: false } }
                }
            };

            function renderMonthlyProfitChart(year) {
                const ctx = document.getElementById('monthlyProfitChart');
                if (!ctx) return;
                const chartCtx = ctx.getContext('2d');
                if (state.charts.monthlyProfit) state.charts.monthlyProfit.destroy();
                
                const months = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString('en-US', {month: 'short'}));
                const monthlyProfits = months.map((_, i) => {
                    return state.dbData
                        .filter(d => new Date(d.date).getFullYear() === year && new Date(d.date).getMonth() === i)
                        .reduce((sum, d) => sum + d.profit, 0);
                });

                state.charts.monthlyProfit = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: `Monthly Profit ${year}`,
                            data: monthlyProfits,
                            backgroundColor: '#4A90E2',
                            borderRadius: 4
                        }]
                    },
                    options: chartDefaultOptions
                });
            }

            function renderRevenueSourceChart(data) {
                const ctx = document.getElementById('revenueSourceChart');
                if (!ctx) return;
                const chartCtx = ctx.getContext('2d');
                if (state.charts.revenueSource) state.charts.revenueSource.destroy();
                
                const totalFlourRevenue = data.reduce((sum, d) => sum + d.flourRevenue, 0);
                const totalBranRevenue = data.reduce((sum, d) => sum + d.branRevenue, 0);

                state.charts.revenueSource = new Chart(chartCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Maize Flour', 'Maize Bran'],
                        datasets: [{
                            data: [totalFlourRevenue, totalBranRevenue],
                            backgroundColor: ['#4A90E2', '#50E3C2'],
                            borderColor: '#F0F4F8',
                            borderWidth: 4
                        }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            function renderEntryLog() {
                const tableBody = document.getElementById('log-table-body');
                if (tableBody) {
                    tableBody.innerHTML = state.dbData.slice(0, 10).map(d => `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4">${d.date}</td>
                            <td class="px-6 py-4">${d.maizePurchased.toFixed(2)}</td>
                            <td class="px-6 py-4">${formatCurrency(d.totalRevenue)}</td>
                            <td class="px-6 py-4 font-medium ${d.profit > 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(d.profit)}</td>
                        </tr>
                    `).join('');
                }
                const dateInput = document.getElementById('date');
                if (dateInput) {
                    dateInput.valueAsDate = new Date();
                }
            }

            function renderReportsView() {
                const yearSelect = document.getElementById('report-year');
                const monthSelect = document.getElementById('report-month');

                if (!yearSelect || !monthSelect) {
                    return; 
                }

                const years = [...new Set(state.dbData.map(d => new Date(d.date).getFullYear()))].sort((a, b) => b - a);
                yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
                const months = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString('en-US', {month: 'long'}));
                monthSelect.innerHTML = '<option value="all">All Year</option>' + months.map((m, i) => `<option value="${i}">${m}</option>`).join('');

                const handleReportGeneration = () => {
                    const year = parseInt(yearSelect.value);
                    const month = monthSelect.value === 'all' ? 'all' : parseInt(monthSelect.value);
                    
                    let reportData = state.dbData.filter(d => new Date(d.date).getFullYear() === year);
                    if (month !== 'all') {
                        reportData = reportData.filter(d => new Date(d.date).getMonth() === month);
                    }
                    
                    const reportOutput = document.getElementById('report-output');
                    if (!reportOutput) {
                        return;
                    }

                    if (reportData.length === 0) {
                        reportOutput.innerHTML = `<p class="text-gray-500 text-center">No data available for the selected period.</p>`;
                        return;
                    }

                    const totalPurchased = reportData.reduce((sum, d) => sum + d.maizePurchased, 0);
                    const totalCost = reportData.reduce((sum, d) => sum + d.costMaize, 0);
                    const totalFlour = reportData.reduce((sum, d) => sum + d.flourProduced, 0);
                    const totalBran = reportData.reduce((sum, d) => sum + d.branProduced, 0);
                    const totalRevenue = reportData.reduce((sum, d) => sum + d.totalRevenue, 0);
                    const totalProfit = reportData.reduce((sum, d) => sum + d.profit, 0);
                    const totalMaizeMilledKg = reportData.reduce((sum, d) => sum + d.maizeMilled, 0);
                    const totalMaizeMilledTonnes = (totalMaizeMilledKg / 1000).toFixed(2);
                    const avgMillingLoss = (totalFlour / (totalFlour + totalBran) || 0) * 100;
                    
                    reportOutput.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Report for ${month !== 'all' ? months[month] : ''} ${year}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Total Revenue</p><p class="text-lg font-bold">${formatCurrency(totalRevenue)}</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Total Profit</p><p class="text-lg font-bold text-green-600">${formatCurrency(totalProfit)}</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Total Maize Cost</p><p class="text-lg font-bold">${formatCurrency(totalCost)}</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Maize Purchased</p><p class="text-lg font-bold">${totalPurchased.toFixed(2)} Kg</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Flour Produced</p><p class="text-lg font-bold">${totalFlour.toFixed(2)} Kg</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Maize Milled</p><p class="text-lg font-bold">${totalMaizeMilledTonnes} Tonnes</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Avg Flour Yield</p><p class="text-lg font-bold">${avgMillingLoss.toFixed(1)}%</p></div>
                        </div>
                    `;
                };

                yearSelect.addEventListener('change', handleReportGeneration);
                monthSelect.addEventListener('change', handleReportGeneration);
                handleReportGeneration();
            }

            function renderDownloadReportsView() {
                const downloadYearSelect = document.getElementById('download-year');
                const downloadMonthSelect = document.getElementById('download-month');
                const downloadButton = document.getElementById('download-button');
                const downloadStatus = document.getElementById('download-status');

                if (!downloadYearSelect || !downloadMonthSelect || !downloadButton || !downloadStatus) {
                    return;
                }

                const years = [...new Set(state.dbData.map(d => new Date(d.date).getFullYear()))].sort((a, b) => b - a);
                downloadYearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
                const months = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString('en-US', {month: 'long'}));
                downloadMonthSelect.innerHTML = '<option value="all">All Months</option>' + months.map((m, i) => `<option value="${i}">${m}</option>`).join('');

                downloadButton.onclick = () => {
                    const reportType = document.getElementById('download-report-type').value;
                    const selectedYear = parseInt(downloadYearSelect.value);
                    const selectedMonth = downloadMonthSelect.value === 'all' ? 'all' : parseInt(downloadMonthSelect.value);
                    
                    let dataToDownload = [];
                    let filename = '';
                    let headers = [];

                    if (reportType === 'daily_log') {
                        let filteredData = state.dbData.filter(d => new Date(d.date).getFullYear() === selectedYear);
                        if (selectedMonth !== 'all') {
                            filteredData = filteredData.filter(d => new Date(d.date).getMonth() === selectedMonth);
                        }
                        
                        headers = [
                            "Date", "Fresh Maize Purchased (Kg)", "Unit Price of Fresh Maize (UGX/Kg)", "Cost of Fresh Maize (UGX)",
                            "Maize Milled (Kg)", "Expected Maize Flour (Kg)", "Actual Maize Flour Produced (Kg)",
                            "Milling Loss (Kg)", "Maize Bran Produced (Kg)", "Sales of Maize Flour (Kg)",
                            "Unit Price of Maize Flour (UGX/Kg)", "Sales Revenue - Maize Flour (UGX)",
                            "Sales of Maize Bran (Kg)", "Unit Price of Maize Bran (UGX/Kg)",
                            "Sales Revenue - Maize Bran (UGX)", "Total Daily Sales Revenue (UGX)",
                            "Daily Profit/Loss (UGX)"
                        ];

                        dataToDownload = filteredData.map(row => [
                            row.date, row.maizePurchased, row.maizeUnitPrice, row.costMaize,
                            row.maizeMilled, (row.maizeMilled * 0.70).toFixed(2), row.flourProduced,
                            (row.maizeMilled - (row.flourProduced + row.branProduced)).toFixed(2),
                            row.branProduced, row.flourSold,
                            row.flourPrice, row.flourRevenue,
                            row.branSold, row.branPrice,
                            row.branRevenue, row.totalRevenue,
                            row.profit
                        ]);
                        filename = `daily_log_${selectedYear}${selectedMonth !== 'all' ? `_${months[selectedMonth].toLowerCase()}` : '_all'}.csv`;
                    }
                    
                    if (dataToDownload.length === 0) {
                        downloadStatus.textContent = "No data to download for the selected criteria.";
                        return;
                    }

                    const csvContent = [
                        headers.map(header => `"${header}"`).join(','),
                        ...dataToDownload.map(row => row.map(item => `"${item}"`).join(','))
                    ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    downloadStatus.textContent = `"${filename}" downloaded successfully!`;
                };
            }

            // --- Authentication Form Logic ---
            const authForm = document.getElementById('auth-form');
            const authTitle = document.getElementById('auth-title');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('auth-password');
            const togglePasswordVisibilityButton = document.getElementById('toggle-password-visibility');
            const authErrorMessage = document.getElementById('auth-error-message');
            const emailVerificationMessage = document.getElementById('email-verification-message');

            let isSignUpMode = false;

            if (authForm) {
                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    authErrorMessage.classList.add('hidden');
                    emailVerificationMessage.classList.add('hidden');

                    const email = emailInput.value;
                    const password = passwordInput.value;

                    try {
                        if (isSignUpMode) {
                            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            await sendEmailVerification(userCredential.user);
                            emailVerificationMessage.textContent = 'Verification email sent! Please check your inbox and verify your email to log in.';
                            emailVerificationMessage.classList.remove('hidden');
                            // Changed to alert for better visibility to the user since custom modals are not implemented
                            alert('Account created! Please verify your email to log in.');
                            // Switch back to login mode after successful signup and verification email sent
                            isSignUpMode = false; 
                            authTitle.textContent = 'Staff Login';
                            authSubmitButton.textContent = 'Login';
                            toggleAuthModeButton.textContent = "Don't have an account? Sign Up";
                        } else {
                            await signInWithEmailAndPassword(auth, email, password);
                            // onAuthStateChanged listener handles UI update upon successful login
                        }
                    } catch (error) {
                        let errorMessage = 'An unknown error occurred.';
                        switch (error.code) {
                            case 'auth/user-not-found':
                            case 'auth/wrong-password':
                            case 'auth/invalid-credential': // More generic for newer Firebase versions
                                errorMessage = 'Invalid email or password.';
                                break;
                            case 'auth/email-already-in-use':
                                errorMessage = 'This email is already registered. Try logging in.';
                                break;
                            case 'auth/weak-password':
                                errorMessage = 'Password is too weak. Must be at least 6 characters.';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Invalid email format.';
                                break;
                            case 'auth/network-request-failed':
                                errorMessage = 'Network error. Please check your internet connection.';
                                break;
                            default:
                                errorMessage = `Authentication error: ${error.message}`;
                                console.error("Firebase Auth Error:", error.code, error.message);
                        }
                        if (authErrorMessage) {
                            authErrorMessage.textContent = errorMessage;
                            authErrorMessage.classList.remove('hidden');
                        }
                    }
                });

                if (toggleAuthModeButton) {
                    toggleAuthModeButton.addEventListener('click', () => {
                        isSignUpMode = !isSignUpMode;
                        authTitle.textContent = isSignUpMode ? 'Staff Sign Up' : 'Staff Login';
                        authSubmitButton.textContent = isSignUpMode ? 'Sign Up' : 'Login';
                        toggleAuthModeButton.textContent = isSignUpMode ? 'Already have an account? Login' : "Don't have an account? Sign Up";
                        authErrorMessage.classList.add('hidden'); // Clear error message on mode switch
                        emailVerificationMessage.classList.add('hidden');
                    });
                }
            }

            // --- Toggle Password Visibility ---
            if (togglePasswordVisibilityButton && passwordInput) {
                togglePasswordVisibilityButton.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    togglePasswordVisibilityButton.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí'; // Change icon
                });
            }

            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        state.activeView = 'dashboard'; // Reset view to dashboard on logout
                        updateUI(); // This will trigger the login screen display
                        // Changed to alert for better visibility to the user
                        alert('You have been logged out.');
                    } catch (error) {
                        console.error("Logout error:", error);
                        // Changed to alert for better visibility to the user
                        alert('Error logging out. Please try again.');
                    }
                });
            }

            document.getElementById('daily-entry-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!state.currentUser) {
                    // Changed to alert for better visibility to the user
                    alert('Please log in to add data.');
                    return;
                }

                const newEntry = {
                    date: e.target.elements['date'].value,
                    maizePurchased: parseFloat(e.target.elements['maize-purchased'].value),
                    maizeUnitPrice: parseFloat(e.target.elements['maize-unit-price'].value),
                    flourProduced: parseFloat(e.target.elements['flour-produced'].value),
                    flourSold: parseFloat(e.target.elements['flour-sold'].value),
                    flourPrice: parseFloat(e.target.elements['flour-price'].value),
                    branSold: parseFloat(e.target.elements['bran-sold'].value),
                    branPrice: parseFloat(e.target.elements['bran-price'].value),
                    timestamp: serverTimestamp() // Add server timestamp for consistent ordering
                };
                
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${state.currentUser.uid}/dailyLogs`), newEntry);
                    e.target.reset();
                    const dateInput = document.getElementById('date');
                    if (dateInput) {
                        dateInput.valueAsDate = new Date();
                    }
                    // Changed to alert for better visibility to the user
                    alert('Log entry added successfully!');
                    // Data will automatically update via onSnapshot listener
                } catch (error) {
                    console.error("Error adding document: ", error);
                    // Changed to alert for better visibility to the user
                    alert("Error adding log entry. Please try again.");
                }
            });
            
            document.querySelector('nav').addEventListener('click', (e) => {
                if (e.target.matches('.nav-link')) {
                    const newView = e.target.id.split('-')[1];
                    state.activeView = newView;
                    updateUI();
                }
            });
        }); // End of DOMContentLoaded
    </script>
</body>
</html>
