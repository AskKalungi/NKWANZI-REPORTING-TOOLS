<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NATIVE AGROFOODS UG - Maize Milling Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm & Assuring -->
    <!-- Application Structure Plan: The SPA is structured with a tab-based navigation to separate core user tasks: Dashboard Overview, Daily Data Entry, Detailed Reports, and Download Reports. Data is persistently stored and retrieved from Firebase Firestore. -->
    <!-- Visualization & Content Choices: Report Info -> Goal -> Viz/Presentation Method -> Interaction -> Justification -> Library/Method. 1. Key Metrics (Today's Profit, MTD Sales) -> Inform -> Large Number KPIs -> Instant read -> Provides immediate business health status. 2. Monthly Profit -> Change -> Bar Chart -> Hover for details -> Compares discrete time periods effectively (Chart.js/Canvas). 3. Production & Revenue Mix -> Compare -> Donut Charts -> Hover for percentages -> Ideal for showing part-to-whole composition (Chart.js/Canvas). 4. Daily Operations -> Organize -> HTML Form & Table -> Form submission and display uses Firebase Firestore -> Standard, intuitive method for data entry and real-time review. 5. Downloadable Reports -> Inform/Organize -> Form with Download Button (data from Firestore) -> User selection of report type and period leads to CSV download -> Provides data portability and offline analysis. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F0F4F8; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-h-96px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .nav-link { cursor: pointer; padding: 0.75rem 1.5rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .nav-link.active { border-color: #4A90E2; color: #4A90E2; font-weight: 600; }
        .kpi-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; text-align: center; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="main-content">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">NATIVE AGROFOODS UG</h1>
                    <p class="text-gray-500">Maize Milling Dashboard</p>
                    <!-- User ID display removed as there's no authenticated user -->
                </div>
                <!-- Logout button removed as there's no authentication -->
            </div>
            <nav class="border-b border-gray-200">
                <div class="container mx-auto px-4 flex">
                    <a id="nav-dashboard" class="nav-link active">Dashboard</a>
                    <a id="nav-entry" class="nav-link">Data Entry</a>
                    <a id="nav-reports" class="nav-link">Reports</a>
                    <a id="nav-download" class="nav-link">Download Reports</a>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-4 md:p-8">
            
            <section id="view-dashboard" class="content-section active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">Today's Profit</h3>
                        <p id="kpi-today-profit" class="text-3xl font-bold text-green-600 mt-2">0 UGX</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">This Month's Sales</h3>
                        <p id="kpi-month-sales" class="text-3xl font-bold text-blue-600 mt-2">0 UGX</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">This Month's Profit</h3>
                        <p id="kpi-month-profit" class="text-3xl font-bold text-green-600 mt-2">0 UGX</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">Maize Milled (Tonnes)</h3>
                        <p id="kpi-month-milled-tonnes" class="text-3xl font-bold text-gray-800 mt-2">0 Tonnes</p>
                </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-700">Monthly Profit (Current Year)</h2>
                        <div class="chart-container mt-4">
                            <canvas id="monthlyProfitChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-700">Revenue Sources (YTD)</h2>
                        <div class="chart-container mt-4">
                            <canvas id="revenueSourceChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-entry" class="content-section">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Log Daily Operations</h2>
                        <form id="daily-entry-form" class="space-y-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="date" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="maize-purchased" class="block text-sm font-medium text-gray-700">Fresh Maize Purchased (Kg)</label>
                                <input type="number" step="0.01" id="maize-purchased" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" value="0">
                            </div>
                            <div>
                                <label for="maize-unit-price" class="block text-sm font-medium text-gray-700">Unit Price of Fresh Maize (UGX/Kg)</label>
                                <input type="number" step="0.01" id="maize-unit-price" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" value="0">
                            </div>
                            <!-- New input for Walk-in Maize -->
                            <div>
                                <label for="walk-in-maize" class="block text-sm font-medium text-gray-700">Walk-in Maize (Kg)</label>
                                <input type="number" step="0.01" id="walk-in-maize" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Enter quantity for walk-in clients" value="0">
                            </div>
                            <!-- New input for Milling Price per Kg -->
                            <div>
                                <label for="milling-price-per-kg" class="block text-sm font-medium text-gray-700">Milling Price per Kg (UGX)</label>
                                <input type="number" step="0.01" id="milling-price-per-kg" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Price for milling walk-in maize" value="0">
                            </div>
                            <div>
                                <label for="flour-produced" class="block text-sm font-medium text-gray-700">Actual Maize Flour Produced (Kg)</label>
                                <input type="number" step="0.01" id="flour-produced" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="flour-sold" class="block text-sm font-medium text-gray-700">Sales of Maize Flour (Kg)</label>
                                <input type="number" step="0.01" id="flour-sold" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="flour-price" class="block text-sm font-medium text-gray-700">Unit Price of Maize Flour (UGX/Kg)</label>
                                <input type="number" id="flour-price" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="bran-sold" class="block text-sm font-medium text-gray-700">Sales of Maize Bran (Kg)</label>
                                <input type="number" step="0.01" id="bran-sold" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="bran-price" class="block text-sm font-medium text-gray-700">Unit Price of Maize Bran (UGX/Kg)</label>
                                <input type="number" id="bran-price" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">Add Log Entry</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Recent Entries</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Date</th>
                                        <th scope="col" class="px-6 py-3">Maize In (Kg)</th>
                                        <th scope="col" class="px-6 py-3">Revenue (UGX)</th>
                                        <th scope="col" class="px-6 py-3">Profit (UGX)</th>
                                    </tr>
                                </thead>
                                <tbody id="log-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-reports" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Generate Report</h2>
                    <div class="flex flex-wrap gap-4 items-center mb-6 border-b pb-6">
                        <div>
                            <label for="report-year" class="block text-sm font-medium text-gray-700">Year</label>
                            <select id="report-year" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="report-month" class="block text-sm font-medium text-gray-700">Month</label>
                            <select id="report-month" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="all">All Year</option>
                            </select>
                        </div>
                    </div>
                    <div id="report-output">
                        <p class="text-gray-500 text-center">Select a year and month to generate a report.</p>
                    </div>
                </div>
            </section>

            <section id="view-download" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Download Reports</h2>
                    <div class="flex flex-col md:flex-row gap-4 items-start mb-6 border-b pb-6">
                        <div class="flex-grow w-full md:w-auto">
                            <label for="download-report-type" class="block text-sm font-medium text-gray-700">Report Type</label>
                            <select id="download-report-type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="daily_log">Daily Operations Log (CSV)</option>
                                <!-- Future report types could be added here -->
                                <!-- <option value="monthly_summary">Monthly Summary (CSV)</option> -->
                                <!-- <option value="annual_summary">Annual CSV)</option> -->
                            </select>
                        </div>
                        <div class="w-full md:w-auto">
                            <label for="download-year" class="block text-sm font-medium text-gray-700">Year (for Daily Log)</label>
                            <select id="download-year" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></select>
                        </div>
                        <div class="w-full md:w-auto">
                            <label for="download-month" class="block text-sm font-medium text-gray-700">Month (for Daily Log)</label>
                            <select id="download-month" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="all">All Months</option>
                            </select>
                        </div>
                        <button id="download-button" class="mt-6 md:mt-1 block w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition self-end">Generate & Download</button>
                    </div>
                    <div id="download-status" class="text-center text-gray-600 mt-4"></div>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        // Only import necessary Firestore modules as Auth is removed
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // Firebase config and app ID will be injected by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Initialize Firebase on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            const state = {
                activeView: 'dashboard',
                charts: {},
                dbData: [], // This will now hold data fetched from Firestore
                // isLoggedIn and currentUser are no longer needed for a non-authenticated version
                // authReady is also not needed as there's no auth process
            };

            const processData = (entry) => {
                // maizeMilled now sums both purchased and walk-in maize
                const maizeMilled = (entry.maizePurchased || 0) + (entry.walkInMaizeKg || 0);
                const costMaize = entry.maizePurchased * entry.maizeUnitPrice; // Cost only applies to purchased maize
                const branProduced = maizeMilled * 0.3; // Bran produced from total milled maize
                const flourRevenue = entry.flourSold * entry.flourPrice;
                // Calculate milling revenue from walk-in maize
                const millingRevenue = (entry.walkInMaizeKg || 0) * (entry.millingPricePerKg || 0);
                const branRevenue = entry.branSold * entry.branPrice;
                const totalRevenue = flourRevenue + branRevenue + millingRevenue; // Include milling revenue
                // Profit calculation now includes milling revenue
                const profit = totalRevenue - costMaize;
                return { ...entry, maizeMilled, costMaize, branProduced, flourRevenue, millingRevenue, branRevenue, totalRevenue, profit };
            };

            const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'UGX', minimumFractionDigits: 0 }).format(value);

            function updateUI() {
                const views = document.querySelectorAll('.content-section');
                const navLinks = document.querySelectorAll('.nav-link');

                views.forEach(view => view.classList.remove('active'));
                navLinks.forEach(link => link.classList.remove('active'));

                document.getElementById(`view-${state.activeView}`).classList.add('active');
                document.getElementById(`nav-${state.activeView}`).classList.add('active');

                // No user ID display needed without authentication

                if (state.activeView === 'dashboard') renderDashboard();
                if (state.activeView === 'entry') renderEntryLog();
                if (state.activeView === 'reports') renderReportsView();
                if (state.activeView === 'download') renderDownloadReportsView();
            }

            // --- Firestore Data Listener (for a default/public user) ---
            // For a non-authenticated app, we'll use a fixed 'public' user ID
            // In a real scenario, you might have public data or a single admin user.
            const defaultUserId = 'public_user_id'; // You can change this to a specific ID if needed for public data
            const publicDailyLogsCollectionRef = collection(db, `artifacts/${appId}/public/data/dailyLogs`); // Adjusted path for public data

            // IMPORTANT: For this public data path to work, you MUST set your Firestore Security Rules
            // to allow public read and write access to this specific collection.
            // Go to Firebase Console -> Firestore Database -> Rules tab and add:
            /*
            rules_version = '2';
            service cloud.firestore {
              match /databases/{database}/documents {
                match /artifacts/{appId}/public/data/dailyLogs/{document=**} {
                  allow read, write: if true;
                }
              }
            }
            */
            onSnapshot(publicDailyLogsCollectionRef, (snapshot) => {
                state.dbData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Ensure data has all required fields for processing, or set defaults
                    state.dbData.push(processData({
                        date: data.date,
                        maizePurchased: data.maizePurchased || 0,
                        maizeUnitPrice: data.maizeUnitPrice || 0,
                        walkInMaizeKg: data.walkInMaizeKg || 0, // Include walk-in maize
                        millingPricePerKg: data.millingPricePerKg || 0, // Include milling price
                        flourProduced: data.flourProduced || 0,
                        flourSold: data.flourSold || 0,
                        flourPrice: data.flourPrice || 0,
                        branSold: data.branSold || 0,
                        branPrice: data.branPrice || 0,
                        id: doc.id // Store document ID for potential future use (e.g., editing/deleting)
                    }));
                });
                state.dbData.sort((a,b) => new Date(b.date) - new Date(a.date)); // Sort in memory
                updateUI(); // Re-render UI with new data
            }, (error) => {
                console.error("Error fetching Firestore data:", error);
            });


            function renderDashboard() {
                const today = new Date('2025-06-26T00:00:00'); // Example fixed date for demo purposes
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();

                const todayData = state.dbData.find(d => new Date(d.date).toDateString() === today.toDateString());
                
                const kpiTodayProfit = document.getElementById('kpi-today-profit');
                if (kpiTodayProfit) {
                    kpiTodayProfit.textContent = todayData ? formatCurrency(todayData.profit) : formatCurrency(0);
                }

                const monthData = state.dbData.filter(d => new Date(d.date).getMonth() === currentMonth && new Date(d.date).getFullYear() === currentYear);
                const monthSales = monthData.reduce((sum, d) => sum + d.totalRevenue, 0);
                const monthProfit = monthData.reduce((sum, d) => sum + d.profit, 0);
                const monthMaizeMilledKg = monthData.reduce((sum, d) => sum + d.maizeMilled, 0);
                const monthMaizeMilledTonnes = (monthMaizeMilledKg / 1000).toFixed(2); 

                const kpiMonthSales = document.getElementById('kpi-month-sales');
                if (kpiMonthSales) {
                    kpiMonthSales.textContent = formatCurrency(monthSales);
                }
                const kpiMonthProfit = document.getElementById('kpi-month-profit');
                if (kpiMonthProfit) {
                    kpiMonthProfit.textContent = formatCurrency(monthProfit);
                }
                const kpiMonthMilledTonnes = document.getElementById('kpi-month-milled-tonnes');
                if (kpiMonthMilledTonnes) {
                    kpiMonthMilledTonnes.textContent = `${monthMaizeMilledTonnes} Tonnes`;
                }
                
                const yearData = state.dbData.filter(d => new Date(d.date).getFullYear() === currentYear);
                const yearProfit = yearData.reduce((sum, d) => sum + d.profit, 0);
                const kpiYearProfit = document.getElementById('kpi-year-profit');
                if (kpiYearProfit) {
                    kpiYearProfit.textContent = formatCurrency(yearProfit);
                }
                
                renderMonthlyProfitChart(currentYear);
                renderRevenueSourceChart(yearData);
            }
            
            const chartDefaultOptions = {
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: (value) => new Intl.NumberFormat('en-US', { notation: "compact", compactDisplay: "short" }).format(value) } },
                    x: { grid: { display: false } }
                }
            };

            function renderMonthlyProfitChart(year) {
                const ctx = document.getElementById('monthlyProfitChart');
                if (!ctx) return;
                const chartCtx = ctx.getContext('2d');
                if (state.charts.monthlyProfit) state.charts.monthlyProfit.destroy();
                
                const months = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString('en-US', {month: 'short'}));
                const monthlyProfits = months.map((_, i) => {
                    return state.dbData
                        .filter(d => new Date(d.date).getFullYear() === year && new Date(d.date).getMonth() === i)
                        .reduce((sum, d) => sum + d.profit, 0);
                });

                state.charts.monthlyProfit = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: `Monthly Profit ${year}`,
                            data: monthlyProfits,
                            backgroundColor: '#4A90E2',
                            borderRadius: 4
                        }]
                    },
                    options: chartDefaultOptions
                });
            }

            function renderRevenueSourceChart(data) {
                const ctx = document.getElementById('revenueSourceChart');
                if (!ctx) return;
                const chartCtx = ctx.getContext('2d');
                if (state.charts.revenueSource) state.charts.revenueSource.destroy();
                
                const totalFlourRevenue = data.reduce((sum, d) => sum + d.flourRevenue, 0);
                const totalBranRevenue = data.reduce((sum, d) => sum + d.branRevenue, 0);
                const totalMillingRevenue = data.reduce((sum, d) => sum + d.millingRevenue, 0); // Sum milling revenue

                state.charts.revenueSource = new Chart(chartCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Maize Flour Sales', 'Maize Bran Sales', 'Milling Services'], // Updated labels
                        datasets: [{
                            data: [totalFlourRevenue, totalBranRevenue, totalMillingRevenue], // Include milling revenue
                            backgroundColor: ['#4A90E2', '#50E3C2', '#FFC107'], // Added a new color for milling
                            borderColor: '#F0F4F8',
                            borderWidth: 4
                        }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            function renderEntryLog() {
                const tableBody = document.getElementById('log-table-body');
                if (tableBody) {
                    tableBody.innerHTML = state.dbData.slice(0, 10).map(d => `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4">${d.date}</td>
                            <td class="px-6 py-4">${d.maizeMilled.toFixed(2)}</td> <!-- Display total maize in -->
                            <td class="px-6 py-4">${formatCurrency(d.totalRevenue)}</td>
                            <td class="px-6 py-4 font-medium ${d.profit > 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(d.profit)}</td>
                        </tr>
                    `).join('');
                }
                const dateInput = document.getElementById('date');
                if (dateInput) {
                    dateInput.valueAsDate = new Date();
                }
            }

            function renderReportsView() {
                const yearSelect = document.getElementById('report-year');
                const monthSelect = document.getElementById('report-month');

                if (!yearSelect || !monthSelect) {
                    return; 
                }

                const years = [...new Set(state.dbData.map(d => new Date(d.date).getFullYear()))].sort((a, b) => b - a);
                yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
                const months = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString('en-US', {month: 'long'}));
                monthSelect.innerHTML = '<option value="all">All Year</option>' + months.map((m, i) => `<option value="${i}">${m}</option>`).join('');

                const handleReportGeneration = () => {
                    const year = parseInt(yearSelect.value);
                    const month = monthSelect.value === 'all' ? 'all' : parseInt(monthSelect.value);
                    
                    let reportData = state.dbData.filter(d => new Date(d.date).getFullYear() === year);
                    if (month !== 'all') {
                        reportData = reportData.filter(d => new Date(d.date).getMonth() === month);
                    }
                    
                    const reportOutput = document.getElementById('report-output');
                    if (!reportOutput) {
                        return;
                    }

                    if (reportData.length === 0) {
                        reportOutput.innerHTML = `<p class="text-gray-500 text-center">No data available for the selected period.</p>`;
                        return;
                    }

                    const totalPurchased = reportData.reduce((sum, d) => sum + d.maizePurchased, 0);
                    const totalWalkInMaize = reportData.reduce((sum, d) => sum + d.walkInMaizeKg, 0); // Sum walk-in maize
                    const totalMillingRevenue = reportData.reduce((sum, d) => sum + d.millingRevenue, 0); // Sum milling revenue
                    const totalCost = reportData.reduce((sum, d) => sum + d.costMaize, 0);
                    const totalFlour = reportData.reduce((sum, d) => sum + d.flourProduced, 0);
                    const totalBran = reportData.reduce((sum, d) => sum + d.branProduced, 0);
                    const totalRevenue = reportData.reduce((sum, d) => sum + d.totalRevenue, 0);
                    const totalProfit = reportData.reduce((sum, d) => sum + d.profit, 0);
                    const totalMaizeMilledKg = reportData.reduce((sum, d) => sum + d.maizeMilled, 0); // This already sums purchased + walk-in
                    const totalMaizeMilledTonnes = (totalMaizeMilledKg / 1000).toFixed(2);
                    const avgMillingLoss = (totalFlour / (totalFlour + totalBran) || 0) * 100;
                    
                    reportOutput.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Report for ${month !== 'all' ? months[month] : ''} ${year}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Total Revenue</p><p class="text-lg font-bold">${formatCurrency(totalRevenue)}</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Total Profit</p><p class="text-lg font-bold text-green-600">${formatCurrency(totalProfit)}</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Total Maize Cost</p><p class="text-lg font-bold">${formatCurrency(totalCost)}</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Maize Purchased</p><p class="text-lg font-bold">${totalPurchased.toFixed(2)} Kg</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm font-medium text-gray-700">Walk-in Maize</p><p class="text-lg font-bold">${totalWalkInMaize.toFixed(2)} Kg</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm font-medium text-gray-700">Milling Revenue</p><p class="text-lg font-bold">${formatCurrency(totalMillingRevenue)}</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Flour Produced</p><p class="text-lg font-bold">${totalFlour.toFixed(2)} Kg</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Maize Milled</p><p class="text-lg font-bold">${totalMaizeMilledTonnes} Tonnes</p></div>
                            <div class="p-4 bg-gray-50 rounded-lg"><p class="text-sm text-gray-500">Avg Flour Yield</p><p class="text-lg font-bold">${avgMillingLoss.toFixed(1)}%</p></div>
                        </div>
                    `;
                };

                yearSelect.addEventListener('change', handleReportGeneration);
                monthSelect.addEventListener('change', handleReportGeneration);
                handleReportGeneration();
            }

            function renderDownloadReportsView() {
                const downloadYearSelect = document.getElementById('download-year');
                const downloadMonthSelect = document.getElementById('download-month');
                const downloadButton = document.getElementById('download-button');
                const downloadStatus = document.getElementById('download-status');

                if (!downloadYearSelect || !downloadMonthSelect || !downloadButton || !downloadStatus) {
                    return;
                }

                const years = [...new Set(state.dbData.map(d => new Date(d.date).getFullYear()))].sort((a, b) => b - a);
                downloadYearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
                const months = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString('en-US', {month: 'long'}));
                downloadMonthSelect.innerHTML = '<option value="all">All Months</option>' + months.map((m, i) => `<option value="${i}">${m}</option>`).join('');

                downloadButton.onclick = () => {
                    const reportType = document.getElementById('download-report-type').value;
                    const selectedYear = parseInt(downloadYearSelect.value);
                    const selectedMonth = downloadMonthSelect.value === 'all' ? 'all' : parseInt(downloadMonthSelect.value);
                    
                    let dataToDownload = [];
                    let filename = '';
                    let headers = [];

                    if (reportType === 'daily_log') {
                        let filteredData = state.dbData.filter(d => new Date(d.date).getFullYear() === selectedYear);
                        if (selectedMonth !== 'all') {
                            filteredData = filteredData.filter(d => new Date(d.date).getMonth() === selectedMonth);
                        }
                        
                        headers = [
                            "Date", "Fresh Maize Purchased (Kg)", "Unit Price of Fresh Maize (UGX/Kg)", "Cost of Fresh Maize (UGX)",
                            "Walk-in Maize (Kg)", "Milling Price per Kg (UGX)", "Milling Revenue (UGX)", // New headers for walk-in maize
                            "Maize Milled (Kg)", "Expected Maize Flour (Kg)", "Actual Maize Flour Produced (Kg)",
                            "Milling Loss (Kg)", "Maize Bran Produced (Kg)", "Sales of Maize Flour (Kg)",
                            "Unit Price of Maize Flour (UGX/Kg)", "Sales Revenue - Maize Flour (UGX)",
                            "Sales of Maize Bran (Kg)", "Unit Price of Maize Bran (UGX/Kg)",
                            "Sales Revenue - Maize Bran (UGX)", "Total Daily Sales Revenue (UGX)",
                            "Daily Profit/Loss (UGX)"
                        ];

                        dataToDownload = filteredData.map(row => [
                            row.date, row.maizePurchased, row.maizeUnitPrice, row.costMaize,
                            row.walkInMaizeKg, row.millingPricePerKg, row.millingRevenue, // Include walk-in maize and milling data
                            row.maizeMilled, (row.maizeMilled * 0.70).toFixed(2), row.flourProduced,
                            (row.maizeMilled - (row.flourProduced + row.branProduced)).toFixed(2),
                            row.branProduced, row.flourSold,
                            row.flourPrice, row.flourRevenue,
                            row.branSold, row.branPrice,
                            row.branRevenue, row.totalRevenue,
                            row.profit
                        ]);
                        filename = `daily_log_${selectedYear}${selectedMonth !== 'all' ? `_${months[selectedMonth].toLowerCase()}` : '_all'}.csv`;
                    }
                    
                    if (dataToDownload.length === 0) {
                        downloadStatus.textContent = "No data to download for the selected criteria.";
                        return;
                    }

                    const csvContent = [
                        headers.map(header => `"${header}"`).join(','),
                        ...dataToDownload.map(row => row.map(item => `"${item}"`).join(','))
                    ].j